{% extends 'base.html.twig' %}

{% block title %}Blocages et Obstacles - KPIs{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .chart-container {
            position: relative;
            margin: auto;
            height: 400px;
            width: 100%;
        }
        .summary-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-card h3 {
            margin-top: 0;
            color: #495057;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
        }
        .date-range-form {
            margin-bottom: 20px;
        }
        .blocker-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .blocker-item {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .blocker-item:last-child {
            border-bottom: none;
        }
        .target-value {
            font-size: 14px;
            color: #6c757d;
        }
        .warning {
            color: #dc3545;
        }
        .success {
            color: #198754;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <h1 class="mb-4">Blocages et Obstacles</h1>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Qu'est-ce que les Blocages et Obstacles ?</h5>
                            <a href="{{ path('app_blockers_current_sprint') }}" class="btn btn-primary">
                                <i class="bi bi-clock"></i> Voir les blocages du sprint en cours
                            </a>
                        </div>
                        <p class="card-text">
                            Les Blocages et Obstacles mesurent la fréquence et la durée des éléments qui empêchent l'équipe de développement 
                            de progresser sur ses tâches. Ces obstacles peuvent être techniques (dépendance, environnement), 
                            organisationnels (approbation, ressources), ou humains (manque de clarté, absence).
                        </p>
                        <p class="card-text">
                            Identifier et résoudre rapidement ces blocages est une responsabilité clé du Lead Dev pour maintenir 
                            la fluidité du travail et la productivité de l'équipe.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <form class="date-range-form" method="get" action="{{ path('app_blockers_index') }}">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="start" class="form-label">Date de début</label>
                                    <input type="date" class="form-control" id="start" name="start" value="{{ startDate|date('Y-m-d') }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="end" class="form-label">Date de fin</label>
                                    <input type="date" class="form-control" id="end" name="end" value="{{ endDate|date('Y-m-d') }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary d-block w-100">Mettre à jour</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Nombre total de blocages</h3>
                    <div class="summary-value {% if data.total > 5 %}warning{% else %}success{% endif %}">
                        {{ data.total }}
                    </div>
                    <small class="target-value">Cible : < 5</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Durée moyenne</h3>
                    <div class="summary-value {% if data.averageDuration > 1 %}warning{% else %}success{% endif %}">
                        {{ data.averageDuration }} jour(s)
                    </div>
                    <small class="target-value">Cible : < 1 jour</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Tâches bloquées</h3>
                    <div class="summary-value {% if data.blockedPercentage > 10 %}warning{% else %}success{% endif %}">
                        {{ data.blockedPercentage }}%
                    </div>
                    <small class="target-value">Cible : < 10%</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Total des tâches</h3>
                    <div class="summary-value">
                        {{ data.totalTasks }}
                    </div>
                    <small>sur la période</small>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Évolution des blocages</h5>
                        <div class="chart-container">
                            <canvas id="blockersChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <h6>Détail des blocages par mois :</h6>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Mois</th>
                                            <th>Nombre de blocages</th>
                                            <th>Durée moyenne</th>
                                            <th>Détail</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for month in data.monthly %}
                                            <tr>
                                                <td>{{ month.month }}</td>
                                                <td>
                                                    {% if month.count > 0 %}
                                                        <a href="{{ month.link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            {{ month.count }} blocages
                                                        </a>
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if month.count > 0 %}
                                                        {{ (month.totalDuration / month.count)|round(1) }} jour(s)
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if month.blockers|length > 0 %}
                                                        <div class="blocker-list">
                                                            {% for blocker in month.blockers %}
                                                                <div class="blocker-item">
                                                                    <a href="{{ blocker.link }}" target="_blank">{{ blocker.key }}</a>
                                                                    - {{ blocker.summary }}
                                                                    <small class="text-muted d-block">
                                                                        Créé le {{ blocker.created }}
                                                                        {% if blocker.resolved %}
                                                                            - Résolu le {{ blocker.resolved }}
                                                                            ({{ blocker.duration }} jour(s))
                                                                        {% else %}
                                                                            - En cours
                                                                        {% endif %}
                                                                    </small>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% else %}
                                                        Aucun blocage
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('blockersChart').getContext('2d');
            
            const data = {
                labels: {{ data.monthly|map(d => d.month)|json_encode|raw }},
                datasets: [{
                    label: 'Nombre de blocages',
                    data: {{ data.monthly|map(d => d.count)|json_encode|raw }},
                    backgroundColor: 'rgba(220, 53, 69, 0.2)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 2
                }]
            };

            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre de blocages'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mois'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Évolution des blocages mensuelle'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        });
    </script>
{% endblock %} 