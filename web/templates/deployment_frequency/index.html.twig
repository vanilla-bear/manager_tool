{% extends 'base.html.twig' %}

{% block title %}Fréquence de Déploiement - KPIs{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .chart-container {
            position: relative;
            margin: auto;
            height: 400px;
            width: 100%;
        }
        .summary-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-card h3 {
            margin-top: 0;
            color: #495057;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
        }
        .date-range-form {
            margin-bottom: 20px;
        }
        .deployment-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .deployment-item {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .deployment-item:last-child {
            border-bottom: none;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <h1 class="mb-4">Fréquence de Déploiement</h1>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Qu'est-ce que la Fréquence de Déploiement ?</h5>
                        <p class="card-text">
                            La Fréquence de Déploiement mesure la régularité avec laquelle notre équipe met de nouvelles versions ou des mises à jour en production, 
                            les rendant accessibles à nos utilisateurs.
                        </p>
                        <p class="card-text">
                            C'est un indicateur essentiel de notre agilité et de notre capacité à livrer de la valeur de manière continue. 
                            Une fréquence de déploiement élevée signifie que nous mettons constamment des améliorations entre les mains de nos clients.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <form class="date-range-form" method="get" action="{{ path('app_deployment_frequency_index') }}">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="start" class="form-label">Date de début</label>
                                    <input type="date" class="form-control" id="start" name="start" value="{{ startDate|date('Y-m-d') }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="end" class="form-label">Date de fin</label>
                                    <input type="date" class="form-control" id="end" name="end" value="{{ endDate|date('Y-m-d') }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary d-block w-100">Mettre à jour</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="summary-card">
                    <h3>Fréquence moyenne</h3>
                    <div class="summary-value">{{ data.average|number_format(1) }}</div>
                    <small>déploiements/mois</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="summary-card">
                    <h3>Total des déploiements</h3>
                    <div class="summary-value">{{ data.total }}</div>
                    <small>sur la période</small>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Évolution de la fréquence de déploiement</h5>
                        <div class="chart-container">
                            <canvas id="deploymentChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <h6>Détail des déploiements par mois :</h6>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Mois</th>
                                            <th>Nombre de déploiements</th>
                                            <th>Détail</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for month in data.monthly %}
                                            <tr>
                                                <td>{{ month.month }}</td>
                                                <td>
                                                    {% if month.count > 0 %}
                                                        <a href="{{ month.link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            {{ month.count }} déploiements
                                                        </a>
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if month.deployments|length > 0 %}
                                                        <div class="deployment-list">
                                                            {% for deployment in month.deployments %}
                                                                <div class="deployment-item">
                                                                    <a href="{{ deployment.link }}" target="_blank">{{ deployment.key }}</a>
                                                                    - {{ deployment.summary }}
                                                                    <small class="text-muted d-block">{{ deployment.date }}</small>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% else %}
                                                        Aucun déploiement
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('deploymentChart').getContext('2d');
            
            const data = {
                labels: {{ data.monthly|map(d => d.month)|json_encode|raw }},
                datasets: [{
                    label: 'Nombre de déploiements',
                    data: {{ data.monthly|map(d => d.count)|json_encode|raw }},
                    backgroundColor: 'rgba(13, 110, 253, 0.2)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 2
                }]
            };

            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre de déploiements'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mois'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Fréquence de déploiement mensuelle'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        });
    </script>
{% endblock %} 