{% extends 'base.html.twig' %}

{% block title %}Débit - KPIs{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .chart-container {
            position: relative;
            margin: auto;
            height: 400px;
            width: 100%;
        }
        .summary-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-card h3 {
            margin-top: 0;
            color: #495057;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
        }
        .date-range-form {
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <h1 class="mb-4">Débit</h1>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Qu'est-ce que le Débit ?</h5>
                        <p class="card-text">
                            Le Débit mesure notre cadence de livraison concrète. Il s'agit du nombre d'éléments (fonctionnalités, bugs, améliorations) 
                            que notre équipe réussit à compléter et à déployer en production sur une période donnée.
                        </p>
                        <p class="card-text">
                            Contrairement à la vélocité qui utilise des points d'histoire, le Débit se concentre sur le nombre brut d'éléments livrés, 
                            donnant une vue directe de la valeur que nous mettons entre les mains de nos utilisateurs.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <form class="date-range-form" method="get" action="{{ path('app_throughput_index') }}">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="start" class="form-label">Date de début</label>
                                    <input type="date" class="form-control" id="start" name="start" value="{{ startDate|date('Y-m-d') }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="end" class="form-label">Date de fin</label>
                                    <input type="date" class="form-control" id="end" name="end" value="{{ endDate|date('Y-m-d') }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary d-block w-100">Mettre à jour</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Débit moyen</h3>
                    <div class="summary-value">{{ data.averages.total|number_format(1) }}</div>
                    <small>éléments/sprint</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Fonctionnalités</h3>
                    <div class="summary-value">{{ data.averages.features|number_format(1) }}</div>
                    <small>par sprint</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Bugs</h3>
                    <div class="summary-value">{{ data.averages.bugs|number_format(1) }}</div>
                    <small>par sprint</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Améliorations</h3>
                    <div class="summary-value">{{ data.averages.improvements|number_format(1) }}</div>
                    <small>par sprint</small>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Bug Tasks</h3>
                    <div class="summary-value">{{ data.averages.bug_tasks|number_format(1) }}</div>
                    <small>par sprint</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <h3>Total Bug Tasks</h3>
                    <div class="summary-value">{{ data.summary.total_bug_tasks }}</div>
                    <small>sur la période</small>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Débit par sprint</h5>
                        <div class="chart-container">
                            <canvas id="throughputChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <h6>Liens rapides vers Jira :</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Sprint</th>
                                            <th>Période</th>
                                            <th>Total</th>
                                            <th>Fonctionnalités</th>
                                            <th>Bugs</th>
                                            <th>Améliorations</th>
                                            <th>Bug Tasks</th>
                                            <th>Points terminés</th>
                                            <th>Devs terminés</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for sprint in data.sprints %}
                                            <tr>
                                                <td><strong>{{ sprint.sprint }}</strong></td>
                                                <td><small>{{ sprint.period }}</small></td>
                                                <td>
                                                    {% if sprint.total > 0 %}
                                                        <a href="{{ sprint.links.total }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            {{ sprint.total }} tickets
                                                        </a>
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if sprint.features > 0 %}
                                                        <a href="{{ sprint.links.features }}" target="_blank" class="btn btn-sm btn-outline-success">
                                                            {{ sprint.features }} tickets
                                                        </a>
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if sprint.bugs > 0 %}
                                                        <a href="{{ sprint.links.bugs }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                                            {{ sprint.bugs }} tickets
                                                        </a>
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if sprint.improvements > 0 %}
                                                        <a href="{{ sprint.links.improvements }}" target="_blank" class="btn btn-sm btn-outline-warning">
                                                            {{ sprint.improvements }} tickets
                                                        </a>
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if sprint.bug_tasks > 0 %}
                                                        <a href="{{ sprint.links.bug_tasks }}" target="_blank" class="btn btn-sm btn-outline-dark">
                                                            {{ sprint.bug_tasks }} tasks
                                                        </a>
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">{{ sprint.completed_points|number_format(1) }} pts</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">{{ sprint.devs_terminés }} tickets</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('throughputChart').getContext('2d');
            
            const data = {
                labels: {{ data.sprints|map(d => d.sprint)|json_encode|raw }},
                datasets: [
                    {
                        label: 'Total',
                        data: {{ data.sprints|map(d => d.total)|json_encode|raw }},
                        backgroundColor: 'rgba(13, 110, 253, 0.2)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Fonctionnalités',
                        data: {{ data.sprints|map(d => d.features)|json_encode|raw }},
                        backgroundColor: 'rgba(25, 135, 84, 0.2)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Bugs',
                        data: {{ data.sprints|map(d => d.bugs)|json_encode|raw }},
                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Améliorations',
                        data: {{ data.sprints|map(d => d.improvements)|json_encode|raw }},
                        backgroundColor: 'rgba(255, 193, 7, 0.2)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Bug Tasks',
                        data: {{ data.sprints|map(d => d.bug_tasks)|json_encode|raw }},
                        backgroundColor: 'rgba(108, 117, 125, 0.2)',
                        borderColor: 'rgba(108, 117, 125, 1)',
                        borderWidth: 2
                    }
                ]
            };

            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre d\'éléments'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sprint'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Débit par sprint'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        });
    </script>
{% endblock %} 